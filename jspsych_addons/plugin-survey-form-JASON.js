var AllQuestionsValid = false

var jsPsychSurveyHtmlForm = (function (jspsych) {
  'use strict';
    
  const info = {
      name: "survey-html-form",
      parameters: {
        /** Array containing one or more objects with parameters for the question(s) that should be shown on the page. */
          survey_json: {
              type: jspsych.ParameterType.JSON,              
              pretty_name: "Questions",
             
          },
          /** HTML formatted string containing all the input elements to display. Every element has to have its own distinctive name attribute. The <form> tag must not be included and is generated by the plugin. */
          html: {
              type: jspsych.ParameterType.HTML_STRING,
              pretty_name: "HTML",
              default: null,
          },
          /** HTML formatted string to display at the top of the page above all the questions. */
          preamble: {
              type: jspsych.ParameterType.HTML_STRING,
              pretty_name: "Preamble",
              default: null,
          },
          /** Label of the button to submit responses. */
          button_label: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Button label",
              default: "Continue",
          },
          /** Label on the popup when a question is missed. */
          missed_question_label: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Valid check",
              default: "Please select an item",
          },
          /** Label next to submit button when a question is missed. */
          missed_question_text: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Valid check",
              default: "Please answer all questions",
          },

          /** The HTML element ID of a form field to autofocus on. */
          autofocus: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Element ID to focus",
              default: "",
          },
          /** Retrieve the data as an array e.g. [{name: "INPUT_NAME", value: "INPUT_VALUE"}, ...] instead of an object e.g. {INPUT_NAME: INPUT_VALUE, ...}. */
          dataAsArray: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Data As Array",
              default: false,
          },
          /** Setting this to true will enable browser auto-complete or auto-fill for the form. */
          autocomplete: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Allow autocomplete",
              default: false,
          },
          ValidSubmission: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Valid form",
              default: false,
          
          }
      },
  };
  /**
   * **survey-html-form**
   *
   * jsPsych plugin for displaying free HTML forms and collecting responses from all input elements
   *
   * @author Jan Simson
   * @see {@link https://www.jspsych.org/plugins/jspsych-survey-html-form/ survey-html-form plugin documentation on jspsych.org}
   */
  class SurveyHtmlFormPlugin {
      constructor(jsPsych) {
          this.jsPsych = jsPsych;
      }
        

      trial(display_element, trial) {

          var html = "";
        html += "JASON"
        html += '<form id="regForm">'
  html += "<h1>Register:</h1>"
  //<!-- One "tab" for each step in the form: -->
  html += '<div class="tab">Name:'
    html += `<p><input placeholder="First name..." oninput="this.className = ''" name="fname"></p>`
    html += `<p><input placeholder="Last name..." oninput="this.className = ''" name="lname"></p>`
  html += "</div>"
  html += '<div class="tab">Contact Info:'
    html += `<p><input placeholder="E-mail..." oninput="this.className = ''" name="email"></p>`
    html += `<p><input placeholder="Phone..." oninput="this.className = ''" name="phone"></p>`
  html += "</div>"
  html += '<div class="tab">Birthday'
    html += `<p><input placeholder="dd" oninput="this.className = ''" name="dd"></p>`
    html += `<p><input placeholder="mm" oninput="this.className = ''" name="nn"></p>`
    html += `<p><input placeholder="yyyy" oninput="this.className = ''" name="yyyy"></p>`
  html += "</div>"
  html += '<div class="tab">Login Info:'
    html += `<p><input placeholder="Username..." oninput="this.className = ''" name="uname"></p>`
    html += `<p><input placeholder="Password..." oninput="this.className = ''" name="pword" type="password"></p>`
  html += "</div>"
  html += `<div style="overflow:auto;">`
    html += `<div style="float:right;">`
      html += `<button type="button" id="prevBtn" onclick="nextPrev(-1)">Previous</button>`
      html += `<button type="button" id="nextBtn" onclick="nextPrev(1)">Next</button>`
    html += "</div>"
  html += "</div>"
  //<!-- Circles which indicates the steps of the form: -->
  html += `<div style="text-align:center;margin-top:40px;">`
    html += `<span class="step"></span>`
    html += `<span class="step"></span>`
    html += `<span class="step"></span>`
    html += `<span class="step"></span>`
  html += "</div>"
html += "</form>"






        display_element.innerHTML = html;

        showTab(0)
      }
    }    
  SurveyHtmlFormPlugin.info = info;

  return SurveyHtmlFormPlugin;

})(jsPsychModule);


// if a visibleIf question is found when looping over the JSON          
// then change the functionaility of the question or the onChange function




   function nextPrev(n) {
        // This function will figure out which tab to display
        var x = document.getElementsByClassName("tab");
        // Exit the function if any field in the current tab is invalid:
        if (n == 1 && !validateForm()) return false;
        // Hide the current tab:
        x[currentTab].style.display = "none";
        // Increase or decrease the current tab by 1:
        currentTab = currentTab + n;
        // if you have reached the end of the form...
        if (currentTab >= x.length) {
            // ... the form gets submitted:
            document.getElementById("regForm").submit();
            return false;
        }
        // Otherwise, display the correct tab:
        showTab(currentTab);
    }
function showTab(n) {
        // This function will display the specified tab of the form...
        var x = document.getElementsByClassName("tab");
        console.log(n)
        console.log(x)
            x[n].style.display = "block";
        //... and fix the Previous/Next buttons:
        if (n == 0) {
            document.getElementById("prevBtn").style.display = "none";
        } else {
            document.getElementById("prevBtn").style.display = "inline";
        }
        if (n == (x.length - 1)) {
            document.getElementById("nextBtn").innerHTML = "Submit";
        } else {
            document.getElementById("nextBtn").innerHTML = "Next";
        }
        //... and run a function that will display the correct step indicator:
        fixStepIndicator(n)
    }

 
    function validateForm() {
        // This function deals with validation of the form fields
        var x, y, i, valid = true;
        x = document.getElementsByClassName("tab");
        y = x[currentTab].getElementsByTagName("input");
        // A loop that checks every input field in the current tab:
        for (i = 0; i < y.length; i++) {
            // If a field is empty...
            if (y[i].value == "") {
            // add an "invalid" class to the field:
            y[i].className += " invalid";
            // and set the current valid status to false
            valid = false;
            }
        }
        // If the valid status is true, mark the step as finished and valid:
        if (valid) {
            document.getElementsByClassName("step")[currentTab].className += " finish";
        }
        return valid; // return the valid status
    }

    function fixStepIndicator(n) {
        // This function removes the "active" class of all steps...
        var i, x = document.getElementsByClassName("step");
        for (i = 0; i < x.length; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }
        //... and adds the "active" class on the current step:
        x[n].className += " active";
    }

// https://stackoverflow.com/questions/29321494/show-input-field-only-if-a-specific-option-is-selected
function ModifyOnChange(elementToChange) {
    var splitInput = elementToChange.split('___')
    //get current question
    var e = document.getElementById(splitInput[0])
    // The values provided for each option should be arbitray form the code's point of view
    // what is the option index for the selected option?
    if (e.options[e.options.selectedIndex].innerHTML == splitInput[2]) {
        f = document.getElementById("div-"+splitInput[1])
        f.style="display: visible"
        s = document.getElementById("div-"+splitInput[1]).getElementsByClassName("surveyFormSelect")[0]
        
        //f.setAttribute('required','')
        //s.required = true;
        //console.log(s)
    }
}



function InternalValidateForm(form) {
    
    // Add a variable to determine if all questions are answered
    AllQuestionsValid = true
    console.log(AllQuestionsValid)
    var AllQuestions = document.getElementsByClassName("surveyFormDiv")
    var NQuestions = AllQuestions.length
    //console.log(document.querySelector('input[name="loneliness002"]:checked').value)
    for ( var i = 0; i < NQuestions; i++ ) {
        // get the name of each question
        if ( AllQuestions[i].getElementsByClassName("surveyFormSelect").length > 0 )
        { // THIS IS A DROPDOWN QUESTION 
             //console.log(AllQuestions[i].style.display != 'none')
            //console.log(AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].selectedIndex)
            // Add check to see if a question is visible or not before deciding if it needs to be answered.

            // This is still checking to see if non needed questions are being answered or not
            if ( AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].selectedIndex == 0 ) {
                if ( AllQuestions[i].style.display != 'none' ) {
                    AllQuestionsValid = false
                    document.getElementById("div-"+AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].id).style.backgroundColor = '#FFC0CB'
                    document.getElementById("tableMessageBox").style = "block"
                    document.getElementById("tableMessageBox").style.backgroundColor = '#FFC0CB' 
                }
            }
            else { // reset the background color
                document.getElementById("div-"+AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].id).style.backgroundColor = '#FFF'
            }
        }
        else if ( AllQuestions[i].getElementsByClassName("radiogroup").length )
        {
            // THIS IS A RADIO GROUP QUESTION 
            document.getElementById("tableMessageBox").style.backgroundColor = "#FFF"
            var CurrentQuestionName = AllQuestions[i].getElementsByClassName("radiogroup")[0].name
            //console.log(CurrentQuestionName+": "+document.querySelector('input[name="'+CurrentQuestionName+'"]:checked').value)
            if (document.querySelector('input[name="'+CurrentQuestionName+'"]:checked'))
            {
                document.getElementById("div-"+CurrentQuestionName).style.backgroundColor = '#FFF'
            }
            else {
                AllQuestionsValid = false
                // what os the DIV element for this question?
                document.getElementById("div-"+CurrentQuestionName).style.backgroundColor = '#FFC0CB'
                document.getElementById("tableMessageBox").style = "block"
                document.getElementById("tableMessageBox").style.backgroundColor = '#FFC0CB' 
            }
        }
        else if ( AllQuestions[i].getElementsByClassName("timeInput").length )
        { 

            console.log("FOUND TIME INPUT")
            
            var CurrentQuestionName = AllQuestions[i].getElementsByClassName("timeInput")[0].name
            if ( AllQuestions[i].getElementsByClassName("timeInput")[0].value == '' ) {
                AllQuestionsValid = false
                document.getElementById("div-"+CurrentQuestionName).style.backgroundColor = '#FFC0CB'
                document.getElementById("tableMessageBox").style = "block"
                document.getElementById("tableMessageBox").style.backgroundColor = '#FFC0CB' 
            }
            else { 
                document.getElementById("div-"+CurrentQuestionName).style.backgroundColor = '#FFF'
            }

            console.log(CurrentQuestionName)
            console.log(AllQuestions[i].getElementsByClassName("surveyFormTime")) 

        }
    }

    /* for ( var i = 0; i < NQuestions; i++ ) {
        //console.log(AllQuestions[i].style.display != 'none')
        //console.log(AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].selectedIndex)
        // Add check to see if a question is visible or not before deciding if it needs to be answered.
        console.log(AllQuestions[i].getElementsByClassName("surveyFormSelect"))
        console.log(AllQuestions[i].getElementsByClassName("surveryFormRadioGroup"))

        if ( AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].selectedIndex == 0 ) {
            if ( AllQuestions[i].style.display != 'none' ) {
                document.getElementById("div-"+AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].id).style.backgroundColor = '#FFC0CB'
                document.getElementById("tableMessageBox").style = "block"
                document.getElementById("tableMessageBox").style.backgroundColor = '#FFC0CB' 
            }
        }
        else { // reset the background color
            document.getElementById("div-"+AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].id).style.backgroundColor = '#FFF'
        }
        console.log(AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].id)
        console.log(AllQuestions[i])
    }*/
        console.log(AllQuestionsValid)
}