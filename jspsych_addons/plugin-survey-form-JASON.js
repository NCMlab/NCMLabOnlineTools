var AllQuestionsValid = false

var jsPsychSurveyHtmlForm = (function (jspsych) {
  'use strict';
    
  const info = {
      name: "survey-html-form",
      parameters: {
        /** Array containing one or more objects with parameters for the question(s) that should be shown on the page. */
          survey_json: {
              type: jspsych.ParameterType.JSON,              
              pretty_name: "Questions",
             
          },
          /** HTML formatted string containing all the input elements to display. Every element has to have its own distinctive name attribute. The <form> tag must not be included and is generated by the plugin. */
          html: {
              type: jspsych.ParameterType.HTML_STRING,
              pretty_name: "HTML",
              default: null,
          },
          /** HTML formatted string to display at the top of the page above all the questions. */
          preamble: {
              type: jspsych.ParameterType.HTML_STRING,
              pretty_name: "Preamble",
              default: null,
          },
          /** Label of the button to submit responses. */
          button_label: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Button label",
              default: "Continue",
          },
          /** Label on the popup when a question is missed. */
          missed_question_label: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Valid check",
              default: "Please select an item",
          },
          /** Label next to submit button when a question is missed. */
          missed_question_text: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Valid check",
              default: "Please answer all questions",
          },

          /** The HTML element ID of a form field to autofocus on. */
          autofocus: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Element ID to focus",
              default: "",
          },
          /** Retrieve the data as an array e.g. [{name: "INPUT_NAME", value: "INPUT_VALUE"}, ...] instead of an object e.g. {INPUT_NAME: INPUT_VALUE, ...}. */
          dataAsArray: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Data As Array",
              default: false,
          },
          /** Setting this to true will enable browser auto-complete or auto-fill for the form. */
          autocomplete: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Allow autocomplete",
              default: false,
          },
          ValidSubmission: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Valid form",
              default: false,
          
          }
      },
  };
  /**
   * **survey-html-form**
   *
   * jsPsych plugin for displaying free HTML forms and collecting responses from all input elements
   *
   * @author Jan Simson
   * @see {@link https://www.jspsych.org/plugins/jspsych-survey-html-form/ survey-html-form plugin documentation on jspsych.org}
   */
  class SurveyHtmlFormPlugin {
      constructor(jsPsych) {
          this.jsPsych = jsPsych;
      }
        

      trial(display_element, trial) {

          var html = "";
        html += '<form id="regForm">'
  


// ====================
var NPages = trial.survey_json.pages.length
// These are the progress dots
html += `<div style="text-align:center;margin-top:40px;">`
for ( var j = 0; j < NPages; j++ )
    { html += `<span class="step"></span>`} 
html += "</div>"

var VisibleIfConditionsPages = []
    
    console.log("==== REVIEWING QUESTIONS FOR VISIBILITY ==== ")
    //var AllQuestionsValid
    for ( var page = 0; page < NPages; page++ ) {
        var VisibleIfConditions = []
        var NQuestions = trial.survey_json.pages[page].elements.length
        for ( var i = 0; i < NQuestions; i++ ) {
            var thisQ = {}
            var thisQuestion = trial.survey_json.pages[page].elements[i]
            
            if ( thisQuestion.visibleIf ) {
                
                // https://stackoverflow.com/questions/29830628/how-to-regex-after-equal-sign
                var ConditionToMeet = thisQuestion.visibleIf.split("==")[1]
                Str = 'style="display: none"'
                thisQ['div'] = Str
                thisQ['name'] = thisQuestion.name
                // decode the visible if condition
                var matches = thisQuestion.visibleIf.match(/\{(.*?)\}/);
                var ThisQuestionIsConditionalOn = matches[1]
                // thisQuestion.name is VISIBLE if  ThisQuestionIsConditionalOn is changed to be ConditionToMeet
                // Find this question and edit it
                let obj = VisibleIfConditions.find((o, index) => 
                    {
                        
                        if (o.name === ThisQuestionIsConditionalOn) {
                            // Now that we found the question that the current question is conditional ON
                            // we need to find what the condition is. If that condition is met, then make the
                            // set the onChange function to make this question visible.
                            // This could look like onChange(this, "the selected value to define the condition is met", the Question ID to make visible)
                            
                            // If more than one question is supposed to be made visible by one answer
                            // then deal with that scenario 
                            if ( 'onChangeQuestion' in VisibleIfConditions[index]) 
                                {
                                    VisibleIfConditions[index]['onChangeQuestion'].push(thisQuestion.name)
                                    VisibleIfConditions[index]['onChangeCondition'].push(ConditionToMeet.trim())
                                } 
                            else {
                                VisibleIfConditions[index]['onChangeQuestion'] = []
                                VisibleIfConditions[index]['onChangeQuestion'].push(thisQuestion.name)
                                VisibleIfConditions[index]['onChangeCondition'] = []
                                VisibleIfConditions[index]['onChangeCondition'].push(ConditionToMeet.trim())
                            }
                            
                            return true;
                        }
                    })
            } 
            else {
                var Str = 'style="display: visible"'
                thisQ['div'] = Str
                thisQ['name'] = thisQuestion.name
            }
            VisibleIfConditions.push(thisQ)
        }
        VisibleIfConditionsPages.push(VisibleIfConditions)
    }
        
        var Str = ''
        
            for ( var page = 0; page < NPages; page++ ) {
                //console.log(trial.survey_json.pages[page])
                var NQuestions = trial.survey_json.pages[page].elements.length
                Str += '<div class="tab">'
                Str += '<h1>'+trial.survey_json.pages[page].title+'</h1>'


                for ( var i = 0; i < NQuestions; i++ ) {
                    //console.log('Page: '+page+', Question: '+i)
                    //console.log("VISIBLE: "+VisibleIfConditionsPages[page][i].div)
                    var thisQuestion = trial.survey_json.pages[page].elements[i]
                    // process dropdown questions
                    //console.log(thisQuestion)
                    switch(thisQuestion.type) {
                        case 'dropdown':
                            console.log("========= DROPDOWN QUESTION ==========")
                            Str += '<div class="surveyFormDiv" id="div-'+thisQuestion.name+'" '+VisibleIfConditionsPages[page][i].div+'>'
                            Str += '<label class="surveyFormLabel">'+thisQuestion.title+'</label><p>'

                            // the visible class is used to only use visible questions when validating 
                            // the form.
                            if ( VisibleIfConditionsPages[page][i].onChangeCondition ) {
                                Str += '<select class="surveyFormSelect FormInput visible"'
                                Str += 'onChange="ModifyOnChange(\''+thisQuestion.name+'___'+VisibleIfConditionsPages[page][i].onChangeQuestion+'___'+VisibleIfConditionsPages[page][i].onChangeCondition+'\')" '                     
                            }
                            else { Str += '<select class="surveyFormSelect FormInput"' }
                            // only set the visible questions to be required
                            //if ( ! thisQuestion.visibleIf ) {
                            //    Str += ' required '
                            //}
                            Str += '"name="'+thisQuestion.name+'" id="'+thisQuestion.name+'" '
                            Str += 'oninvalid="this.setCustomValidity(\''+ trial.missed_question_label +'\')"'
                            Str += '>'
                            if (Object.hasOwn(thisQuestion,'choicesMin'))
                            {
                                // need to add functionaility to create all choices between the min and max values
                            }
                            else {
                                var NChoices = thisQuestion.choices.length
                                // add default/blank option
                                Str += '<option disabled selected value> -- </option>'
                                for ( var j = 0; j < NChoices; j++ ) {
                                    //console.log("The choices are: "+thisQuestion.choices[j])
                                    Str += '<option value="'+thisQuestion.choices[j].value+'">'+thisQuestion.choices[j].text+'</option>'
                                }
                            }
                            Str += '</select></div><hr>'

                            break;
                        
                        case 'radiogroup':
                            console.log("========= RADIO GROUP QUESTION ==========") 
                            Str += '<div class="surveyFormDiv surveryFormRadioGroup" id="div-'+thisQuestion.name+'">'
                            
                            Str += '<label class="surveyFormLabel">'+thisQuestion.title+'</label>'
                            // if there is a subtitle add it
                            if ( thisQuestion.subtitle != undefined ) {
                                Str += '<label class="surveyFormSubTitle">'+thisQuestion.subtitle+'</label>'
                            }
                            Str += '<div class="radiogroup_alignment">'
                            var NChoices = thisQuestion.choices.length
                            for ( var j = 0; j < NChoices; j++ )
                            {
                                Str += '<div class radioGroupWrapper>'
                                Str += '<input type="radio"  class="sd-item__decorator radiogroup" id="'+thisQuestion.name+'" name="'+thisQuestion.name+'" value="'+thisQuestion.choices[j].value +'" '
                            Str += 'oninvalid="this.setCustomValidity(\''+ trial.missed_question_label +'\')"'
                            Str += '>' 
                            Str += '<label for="thisQuestion.name'+'_'+j+'" class="surveyFormResponseLabel">' + thisQuestion.choices[j].text+'</label></br>'
                            Str += '</div>'
                            }
                            
                            Str += '</div></div><hr>'
                            break;
                        case 'textarea':
                            console.log("========= TEXT QUESTION ==========")     
                            console.log(thisQuestion)
                            Str += '<div class="surveyFormDiv" id="div-'+thisQuestion.name+'" '+VisibleIfConditionsPages[page][i].div+'>'
                            Str += '<div class="surveyFormTitle" id="div-'+thisQuestion.name+'">'
                            Str += thisQuestion.title
                            //Str += '</div><input class="textInput" name="'+thisQuestion.name+'" type="'+thisQuestion.inputType+'" />'
                            Str += '</div><textarea class="textInput FormInput" rows="'+thisQuestion.textbox_rows+'" cols="80%"></textarea>'
                            Str += '</div><hr>'
                        default:
                            console.log("========= DEFAULT ==========")
                                console.error("Questions of type "+trial.survey_json.pages[page].elements[i].type+" are not availble")
                    }
                }

                // End of a page of questions
                Str += '</div>' // end the tab div
            }// This ends the for loop over pages

            Str += '<div style="overflow:auto;">'
                Str += '<div style="float:right;">'
                Str += '<button type="button" id="prevBtn" onclick="nextPrev(-1)">Previous</button>'
                Str += '<button type="button" id="nextBtn" onclick="nextPrev(1)">Next</button>'
                Str += '</div>'
            Str += '</div>'
            //<!-- Circles which indicates the steps of the form: -->

            

          html += Str
 
        html += "</form>"

        display_element.innerHTML = html;
        // start off by showing the first tab
        showTab(0)
      }
    }    
  SurveyHtmlFormPlugin.info = info;

  return SurveyHtmlFormPlugin;

})(jsPsychModule);


// if a visibleIf question is found when looping over the JSON          
// then change the functionaility of the question or the onChange function

   function nextPrev(n) {
        // This function will figure out which tab to display
        var x = document.getElementsByClassName("tab");
        // Exit the function if any field in the current tab is invalid:
        if (n == 1 && !validateForm()) return false;
        // Hide the current tab:
        x[currentTab].style.display = "none";
        // Increase or decrease the current tab by 1:
        currentTab = currentTab + n;
        // if you have reached the end of the form...
        if (currentTab >= x.length) {
            // ... the form gets submitted:
            document.getElementById("regForm").submit();
            return false;
        }
        // Otherwise, display the correct tab:
        showTab(currentTab);
    }

function showTab(n) {
        // This function will display the specified tab of the form...
        var x = document.getElementsByClassName("tab");
        x[n].style.display = "block";
        //... and fix the Previous/Next buttons:
        if (n == 0) {
            document.getElementById("prevBtn").style.display = "none";
        } else {
            document.getElementById("prevBtn").style.display = "inline";
        }
        if (n == (x.length - 1)) {
            document.getElementById("nextBtn").innerHTML = "Submit";
        } else {
            document.getElementById("nextBtn").innerHTML = "Next";
        }
        //... and run a function that will display the correct step indicator:
        fixStepIndicator(n)
    }

 
    function validateForm() {
        console.log("VALIDATING FORM")
        // This function deals with validation of the form fields
        var x, y, i, valid = true;
        x = document.getElementsByClassName("tab");
        //y = x[currentTab].getElementsByTagName("input");
        y = x[currentTab].getElementsByClassName("FormInput")
        
        // A loop that checks every input field in the current tab:
        for (i = 0; i < y.length; i++) {
            // CHeck to make sure validity is ONLY based on the visible items
            // check to see if the element is in the non-visable class
            // If a field is empty AND visible
            if ( (y[i].value == "") && ( y[i].classList.contains('visible') ) )
            {
                // add an "invalid" class to the field:
                y[i].className += " invalid";
                // and set the current valid status to false
                valid = false;
            }
            else { y[i].classList.remove('invalid') }
        }
        // If the valid status is true, mark the step as finished and valid:
        if (valid) {
            document.getElementsByClassName("step")[currentTab].className += " finish";
        }
        return valid; // return the valid status
    }

    function fixStepIndicator(n) {
        // This function removes the "active" class of all steps...
        var i, x = document.getElementsByClassName("step");
        for (i = 0; i < x.length; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }
        //... and adds the "active" class on the current step:
        x[n].className += " active";
    }

// https://stackoverflow.com/questions/29321494/show-input-field-only-if-a-specific-option-is-selected
function ModifyOnChange(elementToChange) {
    
    var splitInput = elementToChange.split('___')
    
    splitInput[1] = splitInput[1].split(',')
    splitInput[2] = splitInput[2].split(',')
    //get current question
    var e = document.getElementById(splitInput[0])
    // The values provided for each option should be arbitray form the code's point of view
    // what is the option index for the selected option?

    // If this element has been given the invlaid classname, remove it.
    e.classList.remove('invalid')

    for ( k = 0; k < splitInput[1].length; k++ )
        
        if (e.options[e.options.selectedIndex].innerHTML == splitInput[2][k]) {
       
            f = document.getElementById("div-"+splitInput[1][k])
            f.style="display: visible"
            s = document.getElementById("div-"+splitInput[1][k]).getElementsByClassName("surveyFormSelect")[0]
            input = f.getElementsByClassName('FormInput')
            input[0].className += ' visible'
            input[0].classList.remove('non-visible')        

        } 
        else
        {

            f = document.getElementById("div-"+splitInput[1][k])
            input = f.getElementsByClassName('FormInput')
            input[0].className += ' non-visible'
            input[0].classList.remove('visible')
            f.style="display: none"
            s = document.getElementById("div-"+splitInput[1][k]).getElementsByClassName("surveyFormSelect")[0]
            
        }
}

