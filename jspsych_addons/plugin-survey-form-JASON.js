var AllQuestionsValid = false

var jsPsychSurveyHtmlForm = (function (jspsych) {
  'use strict';
    
  const info = {
      name: "survey-html-form",
      parameters: {
        /** Array containing one or more objects with parameters for the question(s) that should be shown on the page. */
          survey_json: {
              type: jspsych.ParameterType.JSON,              
              pretty_name: "Questions",
             
          },
          /** HTML formatted string containing all the input elements to display. Every element has to have its own distinctive name attribute. The <form> tag must not be included and is generated by the plugin. */
          html: {
              type: jspsych.ParameterType.HTML_STRING,
              pretty_name: "HTML",
              default: null,
          },
          /** HTML formatted string to display at the top of the page above all the questions. */
          preamble: {
              type: jspsych.ParameterType.HTML_STRING,
              pretty_name: "Preamble",
              default: null,
          },
          /** Label of the button to submit responses. */
          button_label: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Button label",
              default: "Continue",
          },
          /** Label on the popup when a question is missed. */
          missed_question_label: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Valid check",
              default: "Please select an item",
          },
          /** Label next to submit button when a question is missed. */
          missed_question_text: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Valid check",
              default: "Please answer all questions",
          },

          /** The HTML element ID of a form field to autofocus on. */
          autofocus: {
              type: jspsych.ParameterType.STRING,
              pretty_name: "Element ID to focus",
              default: "",
          },
          /** Retrieve the data as an array e.g. [{name: "INPUT_NAME", value: "INPUT_VALUE"}, ...] instead of an object e.g. {INPUT_NAME: INPUT_VALUE, ...}. */
          dataAsArray: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Data As Array",
              default: false,
          },
          /** Setting this to true will enable browser auto-complete or auto-fill for the form. */
          autocomplete: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Allow autocomplete",
              default: false,
          },
          ValidSubmission: {
              type: jspsych.ParameterType.BOOL,
              pretty_name: "Valid form",
              default: false,
          
          }
      },
  };
  /**
   * **survey-html-form**
   *
   * jsPsych plugin for displaying free HTML forms and collecting responses from all input elements
   *
   * @author Jan Simson
   * @see {@link https://www.jspsych.org/plugins/jspsych-survey-html-form/ survey-html-form plugin documentation on jspsych.org}
   */
  class SurveyHtmlFormPlugin {
      constructor(jsPsych) {
          this.jsPsych = jsPsych;
      }
        

      trial(display_element, trial) {

          var html = "";
        html += '<form id="regForm">'
  


// ====================

var NPages = trial.survey_json.pages.length
// These are the progress dots
console.log(trial)
if ( trial.survey_json.showProgressBar == 'top')
{ 
    html += `<div style="text-align:center;margin-top:40px;">`
    for ( var j = 0; j < NPages; j++ )
        { html += `<span class="step"></span>`} 
    html += "</div>"
}

var VisibleIfConditionsPages = []
    
    console.log("==== REVIEWING QUESTIONS FOR VISIBILITY ==== ")
    //var AllQuestionsValid
// THERE IS AN ISSUE WITH CREATING THE VISIBILITY CONDITIONS WHEN THERE IS AN OR FOR THE RESPONSES
    var VisibleIfConditionsPages = []
    for ( var page = 0; page < NPages; page++ ) {
    var VisibleIfConditions = []
        
        var NQuestions = trial.survey_json.pages[page].elements.length
        console.log("Number of questions: "+NQuestions)
        // cycle over each question
        for ( var i = 0; i < NQuestions; i++ ) {
            var thisQ = {}
            var TEST = {}
            var thisQuestion = trial.survey_json.pages[page].elements[i]
            //console.log(thisQuestion)
            if ( thisQuestion.visibleIf ) {
                
                
                // https://stackoverflow.com/questions/29830628/how-to-regex-after-equal-sign
                var ConditionToMeet = thisQuestion.visibleIf.split("==")[1]
                Str = 'style="display: none"'
                thisQ['div'] = Str
                thisQ['name'] = thisQuestion.name
                TEST['div'] = Str
                TEST['name'] = thisQuestion.name
                TEST['visibleClass'] = 'non-visible'
            }
            else {
                var Str = 'style="display: visible"'
                thisQ['div'] = Str
                thisQ['name'] = thisQuestion.name
                TEST['div'] = Str
                TEST['name'] = thisQuestion.name
                TEST['visibleClass'] = 'visible'
            }
            
            VisibleIfConditions.push(TEST)
        }
        console.log(VisibleIfConditions)
        for ( var i = 0; i < NQuestions; i++ ) {
            var thisQuestion = trial.survey_json.pages[page].elements[i]
            //console.log(thisQuestion)
            if ( thisQuestion.visibleIf ) {
                // decode the visible if condition
                //console.log(thisQuestion.visibleIf)
                
                var MultipleConditions = thisQuestion.visibleIf.split(";")
                var CondMatches = []
                for ( var k = 0; k < MultipleConditions.length; k++ )
                { 
                  //  console.log(MultipleConditions[k].split("==")[1])
                    CondMatches.push(MultipleConditions[k].split("==")[1].trim())
                }
                //console.log(CondMatches) // These are the responses
                //console.log(ConditionToMeet)
                var matches = thisQuestion.visibleIf.match(/\{(.*?)\}/);
                var ThisQuestionIsConditionalOn = matches[1] // The question name
                //console.log("CURRENT QUESTION: "+thisQuestion.name)
                //console.log('QUESTION CONDITIONAL ON:'+matches[1])

                //console.log(ThisQuestionIsConditionalOn)
                //console.log("RESPONSES: "+CondMatches)
            


                // thisQuestion.name is VISIBLE if  ThisQuestionIsConditionalOn is changed to be ConditionToMeet
                // Find this question and edit it
                let obj = VisibleIfConditions.find((o, index) => 
                    {
                        
                        if (o.name === ThisQuestionIsConditionalOn) {
                            
                            
                            // Now that we found the question that the current question is conditional ON
                            // we need to find what the condition is. If that condition is met, then make the
                            // set the onChange function to make this question visible.
                            // This could look like onChange(this, "the selected value to define the condition is met", the Question ID to make visible)
                            
                            // Find the index for this option
                            
                            // console.log('THIS QUESTION: '+thisQuestion.name)
                            // console.log("The index is: "+index) // This is the index of the question with the conditions
                            // Are the om change responses added to this qieston yet?
                            if ( !('onChangeResponses' in VisibleIfConditions[index] ))
                            { 
                                VisibleIfConditions[index]['onChangeResponses'] = []
                                VisibleIfConditions[index]['onChangeQuestions'] = []
                            }
                            let CondIndex
                            for ( var k = 0; k < CondMatches.length; k++ )
                            {
                                if (!( VisibleIfConditions[index]['onChangeResponses'].includes(CondMatches[k])))
                                {
                                    VisibleIfConditions[index]['onChangeResponses'].push(CondMatches[k])
                                    // console.log("CURRENT COND: "+CondMatches[k])
                                    // console.log("CURRENT QUESTION: "+thisQuestion.name)
                                    // need to add the questions to the arrays
                                    // What is the index of this response?
                                    CondIndex = VisibleIfConditions[index]['onChangeResponses'].indexOf(CondMatches[k])
                                    VisibleIfConditions[index]['onChangeQuestions'][CondIndex] = []
                                    VisibleIfConditions[index]['onChangeQuestions'][CondIndex].push(thisQuestion.name)
                                }
                                else { 
                                    // console.log("CURRENT QUESTION: "+thisQuestion.name)
                                    CondIndex = VisibleIfConditions[index]['onChangeResponses'].indexOf(CondMatches[k])
                                    VisibleIfConditions[index]['onChangeQuestions'][CondIndex].push(thisQuestion.name)
                                }
                                // console.log("Cond Index: "+ CondIndex)
                            }                            
                        }
                    })
            }
        }
        VisibleIfConditionsPages.push(VisibleIfConditions)
    }
    
        console.log(VisibleIfConditionsPages)
        var Str = ''
        
            for ( var page = 0; page < NPages; page++ ) {
                //console.log(trial.survey_json.pages[page])
                var NQuestions = trial.survey_json.pages[page].elements.length
                Str += '<div class="tab">'
                if ( trial.survey_json.showTitle )
                { Str += '<h1>'+trial.survey_json.pages[page].title+'</h1>' }


                for ( var i = 0; i < NQuestions; i++ ) {
                    //console.log('Page: '+page+', Question: '+i)
                    //console.log("VISIBLE: "+VisibleIfConditionsPages[page][i].div)
                    var thisQuestion = trial.survey_json.pages[page].elements[i]
                    // process dropdown questions
                    //console.log(thisQuestion)
                    switch(thisQuestion.type) {
                        case 'dropdown':
                            console.log("========= DROPDOWN QUESTION ==========")
                            Str += '<div class="surveyFormDiv '+VisibleIfConditionsPages[page][i].visibleClass+'" id="div-'+thisQuestion.name+'" '+VisibleIfConditionsPages[page][i].div+'>'
                            Str += '<label class="surveyFormLabel">'+thisQuestion.title+'</label><p>'

                            // the visible class is used to only use visible questions when validating 
                            // the form.
                            console.log(VisibleIfConditionsPages[page][i])
                            if ( VisibleIfConditionsPages[page][i].onChangeResponses ) {
                                console.log('=== VISIBLE IF CONDIRTION ===')
                                console.log(VisibleIfConditionsPages[page][i])
                                Str += '<select class="surveyFormSelect FormInput visible"'
                                //Str += 'onChange="ModifyOnChange(\''+thisQuestion.name+'___'+VisibleIfConditionsPages[page][i].onChangeQuestion+'___'+VisibleIfConditionsPages[page][i].onChangeCondition+'\')" '                     
                                
                                var SSS = ''
                                SSS += 'onChange="ModifyOnChange(`'+thisQuestion.name+';;'
                                
                                for ( var k = 0; k < VisibleIfConditionsPages[page][i].onChangeResponses.length; k++ )
                                { 
                                    if ( k > 0 ){ SSS += ',' }
                                    SSS += VisibleIfConditionsPages[page][i].onChangeResponses[k]  
                                }
                                SSS += ';;'
                                // cycle over array of arrays
                                // cycle over responses
                                for ( var k = 0; k < VisibleIfConditionsPages[page][i].onChangeQuestions.length; k++ )
                                { 
                                     if ( k > 0 ){ SSS += ';' }
                                    // cycle over the questions related to each response
                                    for ( var m = 0; m < VisibleIfConditionsPages[page][i].onChangeQuestions[k].length; m++ )
                                    {
                                         if ( m > 0 ){ SSS += ',' }
                                        SSS += VisibleIfConditionsPages[page][i].onChangeQuestions[k][m]
                                    }
                                    
                                }
                                SSS += '`)'
                                //+VisibleIfConditionsPages[page][i].onChangeQuestion+','+VisibleIfConditionsPages[page][i].onChangeCondition+')" '                     
                                console.log(SSS)
                                Str += SSS
                                //console.log(BREAK)
                            }
                            else { Str += '<select class="surveyFormSelect FormInput visible"' }
                            // only set the visible questions to be required
                            //if ( ! thisQuestion.visibleIf ) {
                            //    Str += ' required '
                            //}
                            Str += '"name="'+thisQuestion.name+'" id="'+thisQuestion.name+'" '
                            Str += 'oninvalid="this.setCustomValidity(\''+ trial.missed_question_label +'\')"'
                            Str += '>'
                            if (Object.hasOwn(thisQuestion,'choicesMin'))
                            {
                                // need to add functionaility to create all choices between the min and max values
                                console.log("FOUND MIN")
                                console.log(thisQuestion)
                                var NChoices = thisQuestion.choicesMax - thisQuestion.choicesMin
                                Str += '<option disabled selected value> -- </option>'
                                var CurrentValue = -99
                                for ( var j = 0; j < NChoices + 1; j++ )
                                {
                                    CurrentValue = thisQuestion.choicesMin + j
                                    Str += '<option value="'+CurrentValue+'">'+CurrentValue+'</option>'
                                }
                            }
                            else {
                                var NChoices = thisQuestion.choices.length
                                // add default/blank option
                                Str += '<option disabled selected value> -- </option>'
                                for ( var j = 0; j < NChoices; j++ ) {
                                    //console.log("The choices are: "+thisQuestion.choices[j])
                                    Str += '<option value="'+thisQuestion.choices[j].value+'">'+thisQuestion.choices[j].text+'</option>'
                                }
                            }
                            Str += '</select></div><hr>'

                            break;
                        
                        case 'radiogroup':
                            Str += '<div class="surveyFormDiv surveryFormRadioGroup" id="div-'+thisQuestion.name+'" '+VisibleIfConditionsPages[page][i].div+'>'
                            Str += '<label class="surveyFormLabel">'+thisQuestion.title+'</label><p>'

                            // the visible class is used to only use visible questions when validating 
                            // the form.
                            if ( VisibleIfConditionsPages[page][i].onChangeCondition ) {
                                Str += '<select class="surveyFormSelect FormInput visible"'
                                Str += 'onChange="ModifyOnChange(\''+thisQuestion.name+'___'+VisibleIfConditionsPages[page][i].onChangeQuestion+'___'+VisibleIfConditionsPages[page][i].onChangeCondition+'\')" '                     
                            }
                            else { Str += '<select class="surveyFormSelect FormInput"' }
                            // only set the visible questions to be required
                            //if ( ! thisQuestion.visibleIf ) {
                            //    Str += ' required '
                            //}
                            Str += '"name="'+thisQuestion.name+'" id="'+thisQuestion.name+'" '
                            Str += 'oninvalid="this.setCustomValidity(\''+ trial.missed_question_label +'\')"'
                            Str += '>'
                            if (Object.hasOwn(thisQuestion,'choicesMin'))
                            {
                                // need to add functionaility to create all choices between the min and max values
                            }
                            else {
                                var NChoices = thisQuestion.choices.length
                                // add default/blank option
                                Str += '<option disabled selected value> -- </option>'
                                for ( var j = 0; j < NChoices; j++ ) {
                                    //console.log("The choices are: "+thisQuestion.choices[j])
                                    Str += '<option value="'+thisQuestion.choices[j].value+'">'+thisQuestion.choices[j].text+'</option>'
                                }
                            }
                            Str += '</select></div><hr>'

                            break;

                        // =====
                        case 'radiogroupXX':
                            console.log("========= RADIO GROUP QUESTION ==========") 
                            Str += '<div class="surveyFormDiv surveryFormRadioGroup" id="div-'+thisQuestion.name+'">'
                            
                            Str += '<label class="surveyFormLabel">'+thisQuestion.title+'</label>'
                            // if there is a subtitle add it
                            if ( thisQuestion.subtitle != undefined ) {
                                Str += '<label class="surveyFormSubTitle">'+thisQuestion.subtitle+'</label>'
                            }
                            Str += '<div class="radiogroup_alignment">'
                            var NChoices = thisQuestion.choices.length
                            for ( var j = 0; j < NChoices; j++ )
                            {
                                Str += '<div class radioGroupWrapper>'
                                Str += '<input type="radio"  class="sd-item__decorator radiogroup" id="'+thisQuestion.name+'" name="'+thisQuestion.name+'" value="'+thisQuestion.choices[j].value +'" '
                            Str += 'oninvalid="this.setCustomValidity(\''+ trial.missed_question_label +'\')"'
                            Str += '>' 
                            Str += '<label for="thisQuestion.name'+'_'+j+'" class="surveyFormResponseLabel">' + thisQuestion.choices[j].text+'</label></br>'
                            Str += '</div>'
                            }
                            
                            Str += '</div></div><hr>'
                            break;
                        case 'textarea':
                            console.log("========= TEXT QUESTION ==========")     
                            console.log(thisQuestion)
                            Str += '<div class="surveyFormDiv '+VisibleIfConditionsPages[page][i].visibleClass+'" id="div-'+thisQuestion.name+'" '+VisibleIfConditionsPages[page][i].div+'>'
                            Str += '<div class="surveyFormLabel" id="div-'+thisQuestion.name+'">'
                            Str += thisQuestion.title
                            //Str += '</div><input class="textInput" name="'+thisQuestion.name+'" type="'+thisQuestion.inputType+'" />'
                            Str += '</div><textarea class="textInput FormInput '
                            Str += VisibleIfConditionsPages[page][i].visibleClass
                            Str += '" rows="'+thisQuestion.textbox_rows+'" cols="80%"></textarea>'
                            Str += '</div><hr>'
                            break;
                        case 'input':
                            console.log("========= INPUT QUESTION ==========")     
                            console.log(thisQuestion)
                            Str += '<div class="surveyFormDiv '+VisibleIfConditionsPages[page][i].visibleClass+'" id="div-'+thisQuestion.name+'" '+VisibleIfConditionsPages[page][i].div+'>'
                            Str += '<div class="surveyFormLabel" id="div-'+thisQuestion.name+'">'
                            Str += thisQuestion.title
                            //Str += '</div><input class="textInput" name="'+thisQuestion.name+'" type="'+thisQuestion.inputType+'" />'
                            Str += '</div><p><input type="number" class="numberInput FormInput '
                            Str += VisibleIfConditionsPages[page][i].visibleClass
                            Str += '" width="40%"'
                            if (Object.hasOwn(thisQuestion,'choicesMax'))
                            {  Str += ' max="'+thisQuestion.choicesMax+'" ' }
                            if (Object.hasOwn(thisQuestion,'choicesMin'))
                            {  Str += ' min="'+thisQuestion.choicesMin+'" ' }
                            Str += '></input></p>'
                            Str += '</div><hr>'

                        default:
                            console.log("========= DEFAULT ==========")
                                console.error("Questions of type "+trial.survey_json.pages[page].elements[i].type+" are not availble")
                    }
                }

                // End of a page of questions
                Str += '</div>' // end the tab div
            }// This ends the for loop over pages

            Str += '<table border="0"><tr><td colspan="2">'
            Str += '<div style="overflow:auto;">'
                Str += '<div style="float:right;">'
                Str += '<button type="button" id="prevBtn" onclick="nextPrev(-1)">Previous</button>'
                Str += '<button type="button" id="nextBtn" onclick="nextPrev(1)">Next</button>'
                Str += '</div>'
            Str += '</div>'
            Str += "</td><td colspan='3' class='surveyFormLabel' id='tableMessageBox' style='display: none'>"+trial.missed_question_text+"</td></tr></table>";


            
            
//            Str += '</td></tr></table>'
            //<!-- Circles which indicates the steps of the form: -->

            

          html += Str
 
        html += "</form>"
        if ( trial.survey_json.showProgressBar == 'bot')
        { 
            html += `<div style="text-align:center;margin-top:40px;">`
            for ( var j = 0; j < NPages; j++ )
                { html += `<span class="step"></span>`} 
            html += "</div>"
        }

        display_element.innerHTML = html;
        // start off by showing the first tab
        showTab(0)
      }
    }    

    console.log("GOT HERE")
console.log("GOT HERE")
console.log("GOT HERE")
  SurveyHtmlFormPlugin.info = info;

  return SurveyHtmlFormPlugin;

})(jsPsychModule);


// if a visibleIf question is found when looping over the JSON          
// then change the functionaility of the question or the onChange function

   function nextPrev(n) {
        // This function will figure out which tab to display
        var x = document.getElementsByClassName("tab");
        // Exit the function if any field in the current tab is invalid:
        if (n == 1 && !validateForm()) return false;
        // Hide the current tab:
        x[currentTab].style.display = "none";
        // Increase or decrease the current tab by 1:
        currentTab = currentTab + n;
        // if you have reached the end of the form...
        console.log("Current Tab: "+currentTab)
        console.log("x: ")
        console.log(x)
        
        if (currentTab >= x.length) {
            // ... the form gets submitted:
            console.log('Submitting form: ')
            //document.getElementById("regForm").submit();
            console.log(x)
            PrepareDataForSubmission()
            this.jsPsych.finishTrial();
            
            return false;
        }
        // Otherwise, display the correct tab:
        showTab(currentTab);
    }

function showTab(n) {
        // This function will display the specified tab of the form...
        var x = document.getElementsByClassName("tab");
        x[n].style.display = "block";
        //... and fix the Previous/Next buttons:
        if (n == 0) {
            document.getElementById("prevBtn").style.display = "none";
        } else {
            document.getElementById("prevBtn").style.display = "inline";
        }
        if (n == (x.length - 1)) {
            document.getElementById("nextBtn").innerHTML = "Submit";
        } else {
            document.getElementById("nextBtn").innerHTML = "Next";
        }
        //... and run a function that will display the correct step indicator:
        fixStepIndicator(n)
    }

 
    function validateForm() {
        console.log("VALIDATING FORM")
        // This function deals with validation of the form fields
        var x, y, i, valid = true;
        x = document.getElementsByClassName("tab");
        //y = x[currentTab].getElementsByTagName("input");
        
        // Find all input slots in the form
        y = x[currentTab].getElementsByClassName("FormInput")
        
        // A loop that checks every input field in the current tab:
        for (i = 0; i < y.length; i++) {
            // CHeck to make sure validity is ONLY based on the visible items
            // check to see if the element is in the non-visable class
            // If a field is empty AND visible
            console.log(y[i])
            if ( (y[i].value == "") && ( y[i].classList.contains('visible') ) )
            {
                // add an "invalid" class to the field:
                y[i].className += " invalid";
                // and set the current valid status to false
                valid = false;
                    //document.getElementById("div-"+AllQuestions[i].getElementsByClassName("surveyFormSelect")[0].id).style.backgroundColor = '#FFC0CB'
                    document.getElementById("tableMessageBox").style = "block"
                    document.getElementById("tableMessageBox").style.backgroundColor = '#FFC0CB' 
            }
            else { 
                y[i].classList.remove('invalid') 
            }
        }
        // Check number inputs for valid values
        n = x[currentTab].getElementsByClassName("numberInput")
        console.log(n)
        for ( i = 0; i < n.length; i++ )
        {
            if ( Number(n[i].value) > Number(n[i].max) ) 
            { n[i].className += " invalid"; }
            if ( Number(n[i].value) < Number(n[i].min) ) 
            { n[i].className += " invalid"; }
        }
        // If the valid status is true, mark the step as finished and valid:
        if (valid) {
            console.log(document.getElementsByClassName("step"))
            document.getElementsByClassName("step")[currentTab].className += " finish";
            document.getElementById("tableMessageBox").style = "display: none"
        }
        return valid; // return the valid status
    }

    function fixStepIndicator(n) {
        // This function removes the "active" class of all steps...
        var i, x = document.getElementsByClassName("step");
        for (i = 0; i < x.length; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }
        //... and adds the "active" class on the current step:
        x[n].className += " active";
    }

// https://stackoverflow.com/questions/29321494/show-input-field-only-if-a-specific-option-is-selected

// Still a bit more to do with this.
// The form questions are now correct but the visibleif parts need to be updated.

function ModifyOnChange(elementToChange) {
    console.log("===== MODIFY ON CHANGE ======")
    var splitInput = elementToChange.split(';;')

    // I a happy with how the visible if conditions are made, but now this function needs to interpret them correctly
    splitInput[1] = splitInput[1].split(',')
    splitInput[2] = splitInput[2].split(';')

    //get current question
    var e = document.getElementById(splitInput[0])
    console.log(e)
    // The values provided for each option should be arbitray form the code's point of view
    // what is the option index for the selected option?

    // If this element has been given the invlaid classname, remove it.
    e.classList.remove('invalid')
    console.log("LENGTH: "+ splitInput[1].length)
    // Check to see if any of the conditions have been met
    var ConditionalResponseMadeFlag = false
    var ResponseIndex = -99
    for ( var k = 0; k < splitInput[1].length; k++ )
    {
        if (e.options[e.options.selectedIndex].innerHTML === splitInput[1][k]) 
        { 
            ResponseIndex = k
            ConditionalResponseMadeFlag = true
        }
    }
    if ( ConditionalResponseMadeFlag )
    {
        // cycle over the questions linked to this response
        splitInput[2][ResponseIndex] = splitInput[2][ResponseIndex].split(',')
        for ( var k = 0; k < splitInput[2][ResponseIndex].length; k++ )
        {
            var QuestionsToModify = splitInput[2][ResponseIndex][k]

            f = document.getElementById("div-"+QuestionsToModify)
            f.style="display: visible"
            f.className += ' visible'
            f.classList.remove('non-visible')        
            s = document.getElementById("div-"+QuestionsToModify).getElementsByClassName("surveyFormSelect")[0]
            input = f.getElementsByClassName('FormInput')
            input[0].className += ' visible'
            input[0].classList.remove('non-visible')        
        }
    }
    else 
    {
        // Make sure to hide anything that may have been made visible but know does not need to be
        // splitInput[2][ResponseIndex] = splitInput[2][ResponseIndex].split(',')
        for ( var k = 0; k < splitInput[1].length; k++ )
        {
            splitInput[2][k] = splitInput[2][k].split(',')
            for ( var m = 0; m < splitInput[2][k].length; m++ )    
            {   
                var QuestionsToModify = splitInput[2][k][m]
                f = document.getElementById("div-"+QuestionsToModify)
                f.className += ' non-visible'
                f.classList.remove('visible')        
                input = f.getElementsByClassName('FormInput')
                input[0].className += ' non-visible'
                input[0].classList.remove('visible')
                f.style="display: none"
                s = document.getElementById("div-"+QuestionsToModify).getElementsByClassName("surveyFormSelect")[0]
            }
        }
    }
        
        
}
// Prepare data for submission
function PrepareDataForSubmission()
{
        x = document.getElementsByClassName("tab");
        var AllQuestionsOnThisTab
        AllQuestionsData = []
        // How many tabs/pages are there?
        console.log("Number of pages: "+x.length)
        for ( var currentTab = 0; currentTab < x.length; currentTab++ )
        {
            // every question is embedded in this DIV
            AllQuestionsOnThisTab = x[currentTab].getElementsByClassName("surveyFormDiv")
            for ( var currentQuestion = 0; currentQuestion < AllQuestionsOnThisTab.length; currentQuestion++ )
            {
                var this_question_data = {}

                y = AllQuestionsOnThisTab[currentQuestion].getElementsByClassName("FormInput")
                console.log(y)
                this_question_data.name = y[0].id

                this_question_data.label = AllQuestionsOnThisTab[currentQuestion].getElementsByClassName("surveyFormLabel")[0].innerHTML

                this_question_data.responseValue = Number(y[0].value)

                if (y[0].tagName == "TEXTAREA" )
                { this_question_data.responseText = y[0].value }
                else 
                { 
                    // The value for each question is not the index, it is used for later scoring
                    this_question_data.responseText = y[0][y[0].selectedIndex].text 
                }


                console.log(AllQuestionsOnThisTab[currentQuestion])
                // console.log(AllQuestionsOnThisTab[currentQuestion].getElementsByClassName("surveyFormLabel"))

                // Check for visibility
                console.log(AllQuestionsOnThisTab[currentQuestion].classList.contains('visible'))
                //console.log(y.getElementsByClassName('non-visible'))
                
                if ( AllQuestionsOnThisTab[currentQuestion].classList.contains('visible') )
                { this_question_data.visible = 'Yes' }
                else { this_question_data.visible = 'No' }
    
            
                // console.log(y[0][y[0].value].text)
                
                console.log(this_question_data)
                AllQuestionsData.push(this_question_data)
            }
        }
        console.log(AllQuestionsData)
        //
        
    
    
    // save data
    var trialdata = {
        //rt: response_time,
        response: AllQuestionsData,
    };
    this.jsPsych.finishTrial(trialdata);
}